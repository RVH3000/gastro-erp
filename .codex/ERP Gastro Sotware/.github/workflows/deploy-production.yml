name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      image_digest:
        description: "Backend image digest (sha256:...)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://app.gastro-erp.at
    steps:
      - uses: actions/checkout@v4
      - name: Blue-Green switch with rollback guardrails
        uses: appleboy/ssh-action@v1.2.0
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
          ATRUST_API_KEY: ${{ secrets.ATRUST_API_KEY }}
          ATRUST_CERT_PEM: ${{ secrets.ATRUST_CERT_PEM }}
          PROMETHEUS_URL: ${{ secrets.PROMETHEUS_URL }}
        with:
          host: ${{ secrets.PROD_HOST }}
          username: deploy
          key: ${{ secrets.PROD_SSH_KEY }}
          envs: DATABASE_URL,JWT_SECRET,REDIS_URL,SMTP_HOST,SMTP_PORT,SMTP_USER,SMTP_PASSWORD,DB_PASSWORD,GRAFANA_PASSWORD,ATRUST_API_KEY,ATRUST_CERT_PEM,PROMETHEUS_URL
          script: |
            set -euo pipefail
            cd /opt/gastro-erp
            export BACKEND_IMAGE_DIGEST="${{ github.event.inputs.image_digest }}"
            export APP_ENV="production"
            export OBSERVATION_SECONDS="300"
            export MAX_ERROR_RATE="0.01"
            export MAX_P95_SECONDS="1.0"
            export PROMETHEUS_URL="${PROMETHEUS_URL:-}"
            chmod +x deploy/scripts/blue_green_switch.sh deploy/scripts/rollback.sh
            ./deploy/scripts/blue_green_switch.sh

      - name: Notify Slack on success
        if: success()
        env:
          ALERTMANAGER_SLACK_URL: ${{ secrets.ALERTMANAGER_SLACK_URL }}
        run: |
          set -euo pipefail
          if [[ -n "${ALERTMANAGER_SLACK_URL}" ]]; then
            payload='{"text":"Gastro ERP Production Deploy erfolgreich: '"${{ github.event.inputs.image_digest }}"'"}'
            curl -X POST -H 'Content-type: application/json' --data "${payload}" "${ALERTMANAGER_SLACK_URL}"
          fi
